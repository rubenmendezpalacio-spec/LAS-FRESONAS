<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAS FRESONAS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #ffafbd, #ffc3a0);
            color: #5a2d52;
            padding: 15px;
            min-height: 100vh;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            padding-bottom: 20px;
        }

        header {
            background-color: #ffc3a0;
            background-image: url("https://catalog-provider.s3.us-east-1.amazonaws.com/Extrema/las+fresonas+logo.png");
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            color: #ff4b8b;
            padding: 15px;
            text-align: center;
            min-height: 100px;
            max-height: 180px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        header h1 {
            color: transparent;
            font-size: 0;
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #ffd1dc;
            background: #fff;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            color: #ff4b8b;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: #fff5f7;
            border-bottom: 4px solid #ff4b8b;
        }

        .tab-content {
            display: none;
            padding: 20px 15px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        h2 {
            color: #ff4b8b;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ffd1dc;
            font-size: 1.3rem;
        }

        h3 {
            color: #ff4b8b;
            margin: 15px 0 10px;
            font-size: 1.1rem;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #7a3c6d;
        }

        select, button, input[type="text"], textarea {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid #ffd1dc;
            background-color: white;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ff4b8b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #ff4b8b;
            box-shadow: 0 0 0 3px rgba(255, 75, 139, 0.2);
        }

        button {
            background: linear-gradient(to right, #ff4b8b, #ff8faf);
            color: white;
            border: none;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 10px rgba(255, 75, 139, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 75, 139, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .order-list {
            list-style-type: none;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
            margin-bottom: 20px;
        }

        .order-list::-webkit-scrollbar {
            width: 6px;
        }

        .order-list::-webkit-scrollbar-thumb {
            background: #ff8faf;
            border-radius: 10px;
        }

        .order-item {
            background-color: #fff5f7;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 5px solid #ff4b8b;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
            position: relative;
        }

        .order-header {
            font-weight: bold;
            color: #ff4b8b;
            margin-bottom: 5px;
            font-size: 1.1rem;
            padding-right: 30px;
        }

        .order-details {
            color: #7a5c8d;
            font-size: 0.95rem;
        }

        .delete-btn {
            background: #ff4b8b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 14px;
            cursor: pointer;
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .total-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px dashed #ffd1dc;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
            color: #ff4b8b;
        }

        .hidden {
            display: none;
        }

        .empty-order {
            text-align: center;
            padding: 30px 15px;
            color: #aaa;
            font-style: italic;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #fff5f7;
            border-radius: 12px;
        }
        
        .checkbox-group label, .checkbox-group input {
            cursor: pointer;
        }

        .checkbox-group input {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            margin-bottom: 0;
            accent-color: #ff4b8b;
        }

        .checkbox-group label {
            margin-bottom: 0;
            font-weight: normal;
        }

        .order-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .summary-item {
            display: flex;
            flex-wrap: wrap; /* Añadido para evitar el empalme */
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ddd;
        }

        .summary-total {
            font-weight: bold;
            font-size: 1.2rem;
            color: #ff4b8b;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #ffd1dc;
        }

        .confirmation {
            text-align: center;
            padding: 20px;
            background: #e8f5e9;
            border-radius: 12px;
            margin-top: 20px;
            display: none;
        }

        .confirmation i {
            color: #4caf50;
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        /* Estilos para el historial agrupado */
        .history-group {
            border: 2px solid #ffd1dc;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            position: relative;
        }
        
        .history-group-header {
            font-weight: bold;
            color: #ff4b8b;
            margin-bottom: 10px;
            border-bottom: 1px dashed #ffd1dc;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-product-item {
            font-size: 0.95rem;
            color: #7a5c8d;
            border-bottom: 1px solid #f0f0f0;
            padding: 10px 0;
            position: relative;
        }
        
        .history-product-item:last-child {
            border-bottom: none;
        }
        
        .history-product-item strong {
            color: #4a2442;
        }

        .history-item .delete-btn {
            background: #ff6b6b;
            top: 10px;
            right: 10px;
        }
        .history-item .delete-btn:hover {
            background: #ff4b4b;
        }

        @media (min-width: 768px) {
            body {
                padding: 30px;
            }

            .container {
                max-width: 700px;
            }

            h1 {
                font-size: 2.2rem;
            }

            .tagline {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>LAS FRESONAS</h1>
        </header>

        <div class="tabs">
            <div class="tab active" data-tab="order">Hacer Pedido</div>
            <div class="tab" data-tab="cart">Carrito (<span id="cart-count">0</span>)</div>
            <div class="tab" data-tab="confirm">Confirmar</div>
            <div class="tab" data-tab="history">Historial</div>
        </div>

        <div class="tab-content active" id="order-tab">
            <h2>Armar Pedido</h2>

            <div class="form-group">
                <label for="main-product-type">Selecciona un producto:</label>
                <select id="main-product-type">
                    <option value="">Selecciona un tipo</option>
                    <option value="fresas">Fresas con Crema</option>
                    <option value="marranitas">Marranitas</option>
                    <option value="tostaditas">Tostaditas</option>
                    <option value="cheetos">Cheetos / Doritos</option>
                </select>
            </div>

            <div id="fresas-ingredients" class="product-ingredients hidden">
                <div class="form-group">
                    <label for="fresas-subtype">Tipo de Fresas:</label>
                    <select id="fresas-subtype">
                        <option value="congeladas">Fresas con Crema Congeladas</option>
                        <option value="naturales">Fresas con Crema Naturales</option>
                        <option value="mixtas">Fresas Mixtas (Congeladas + Naturales)</option>
                    </select>
                </div>
                <h3>Complementos y Toppings</h3>
                <div class="form-group">
                    <label for="fresas-complement">Complemento:</label>
                    <select id="fresas-complement">
                        <option value="nada">Ninguno</option>
                        <option value="oreo">Oreo</option>
                        <option value="chips-ahoy">Chips Ahoy</option>
                        <option value="canelitas">Canelitas</option>
                        <option value="gansito">Gansito</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="fresas-topping">Topping:</label>
                    <select id="fresas-topping">
                        <option value="nada">Ninguno</option>
                        <option value="chocolate">Chocolate líquido</option>
                        <option value="cajeta">Cajeta</option>
                        <option value="nutella">Nutella</option>
                        <option value="caramelo">Caramelo</option>
                        <option value="nuez">Nuez</option>
                        <option value="almendra">Almendra</option>
                        <option value="jarabe-fresa">Jarabe de fresa</option>
                    </select>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="fresas-whipped-cream">
                    <label for="fresas-whipped-cream">Agregar Crema Batida</label>
                </div>
            </div>

            <div id="marranitas-ingredients" class="product-ingredients hidden">
                <h3>Ingredientes para Marranitas</h3>
                <div class="checkbox-group">
                    <input type="checkbox" id="marranitas-cacahuate" checked>
                    <label for="marranitas-cacahuate">Cacahuate</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="marranitas-pepino" checked>
                    <label for="marranitas-pepino">Pepino</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="marranitas-tostaditas" checked>
                    <label for="marranitas-tostaditas">Tostaditas</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="marranitas-cueritos" checked>
                    <label for="marranitas-cueritos">Cueritos</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="marranitas-clamato" checked>
                    <label for="marranitas-clamato">Clamato</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="marranitas-tamarindo" checked>
                    <label for="marranitas-tamarindo">Tamarindo</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="marranitas-chamoy" checked>
                    <label for="marranitas-chamoy">Chamoy</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="marranitas-valentina" checked>
                    <label for="marranitas-valentina">Salsa Valentina</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="marranitas-soya" checked>
                    <label for="marranitas-soya">Soya</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="marranitas-limon" checked>
                    <label for="marranitas-limon">Limón</label>
                </div>
            </div>

            <div id="tostaditas-ingredients" class="product-ingredients hidden">
                <h3>Ingredientes para Tostaditas</h3>
                <div class="checkbox-group">
                    <input type="checkbox" id="tostaditas-repollo" checked>
                    <label for="tostaditas-repollo">Repollo</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="tostaditas-cueritos" checked>
                    <label for="tostaditas-cueritos">Cueritos</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="tostaditas-tomate" checked>
                    <label for="tostaditas-tomate">Tomate</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="tostaditas-queso" checked>
                    <label for="tostaditas-queso">Queso</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="tostaditas-valentina" checked>
                    <label for="tostaditas-valentina">Salsa Valentina</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="tostaditas-crema" checked>
                    <label for="tostaditas-crema">Crema</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="tostaditas-limon" checked>
                    <label for="tostaditas-limon">Limón</label>
                </div>
            </div>

            <div id="cheetos-ingredients" class="product-ingredients hidden">
                <div class="form-group">
                    <label for="cheetos-type">Tipo de Cheeto / Dorito:</label>
                    <select id="cheetos-type">
                        <option value="cheetos-flamin">Cheetos Flamin</option>
                        <option value="cheetos-flamin-limon">Cheetos Flamin Limón</option>
                        <option value="cheetos-flamin-xxtra">Cheetos Flamin XXTRA</option>
                        <option value="doritos">Doritos</option>
                    </select>
                </div>
                <h3>Ingredientes para Cheetos / Doritos</h3>
                <div class="checkbox-group">
                    <input type="checkbox" id="cheetos-cueritos" checked>
                    <label for="cheetos-cueritos">Cueritos</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="cheetos-queso" checked>
                    <label for="cheetos-queso">Queso</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="cheetos-crema" checked>
                    <label for="cheetos-crema">Crema</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="cheetos-salsa" checked>
                    <label for="cheetos-salsa">Salsa</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="cheetos-jalapeno" checked>
                    <label for="cheetos-jalapeno">Jalapeño</label>
                </div>
            </div>

            <button id="add-to-cart" class="hidden">
                <i class="fas fa-cart-plus"></i> Agregar al Carrito
            </button>
        </div>

        <div class="tab-content" id="cart-tab">
            <h2>Carrito de Pedidos</h2>
            <ul id="cart-list" class="order-list">
                <li class="order-item empty-order">No hay productos en el carrito. ¡Agrega tu primer pedido!</li>
            </ul>

            <div class="total-section">
                Total de productos: <span id="cart-total">0</span>
            </div>

            <button id="continue-to-confirm">
                <i class="fas fa-check-circle"></i> Continuar a Confirmación
            </button>

            <button id="clear-cart" style="background: #ff6b6b; margin-top: 10px;">
                <i class="fas fa-trash"></i> Vaciar Carrito
            </button>
        </div>

        <div class="tab-content" id="confirm-tab">
            <h2>Confirmar Pedido</h2>

            <div id="order-summary">
                <div class="empty-order">No hay productos para confirmar</div>
            </div>

            <div class="form-group">
                <label for="notes">Notas adicionales:</label>
                <textarea id="notes" placeholder="Notas especiales para el pedido" rows="3" style="width: 100%; padding: 15px; border-radius: 12px; border: 2px solid #ffd1dc;"></textarea>
            </div>

            <button id="confirm-order">
                <i class="fas fa-check"></i> Confirmar Pedido Completo
            </button>

            <div id="confirmation-message" class="confirmation">
                <i class="fas fa-check-circle"></i>
                <h3>¡Pedido Confirmado!</h3>
                <p>Tu pedido ha sido registrado exitosamente.</p>
                <button id="new-order" style="margin-top: 15px;">
                    <i class="fas fa-plus"></i> Hacer Nuevo Pedido
                </button>
            </div>
        </div>

        <div class="tab-content" id="history-tab">
            <h2>Historial de Ventas</h2>
            <div id="history-list">
                <div class="empty-order">No hay pedidos registrados en el historial.</div>
            </div>
            <button id="download-csv" style="margin-top: 20px;">
                <i class="fas fa-download"></i> Descargar Reporte CSV
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mainProductSelect = document.getElementById('main-product-type');
            const fresasIngredients = document.getElementById('fresas-ingredients');
            const marranitasIngredients = document.getElementById('marranitas-ingredients');
            const tostaditasIngredients = document.getElementById('tostaditas-ingredients');
            const cheetosIngredients = document.getElementById('cheetos-ingredients');
            const addToCartBtn = document.getElementById('add-to-cart');
            const cartList = document.getElementById('cart-list');
            const cartCount = document.getElementById('cart-count');
            const cartTotal = document.getElementById('cart-total');
            const clearCartBtn = document.getElementById('clear-cart');
            const continueToConfirmBtn = document.getElementById('continue-to-confirm');
            const orderSummary = document.getElementById('order-summary');
            const confirmOrderBtn = document.getElementById('confirm-order');
            const confirmationMessage = document.getElementById('confirmation-message');
            const newOrderBtn = document.getElementById('new-order');
            const historyList = document.getElementById('history-list');
            const downloadCsvBtn = document.getElementById('download-csv');
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            let cart = [];
            const HISTORY_PIN = '2023';

            loadHistory();

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    if (tabId === 'confirm') {
                        updateOrderSummary();
                    } else if (tabId === 'history') {
                        loadHistory();
                    }
                });
            });

            mainProductSelect.addEventListener('change', function() {
                const selectedProduct = this.value;
                document.querySelectorAll('.product-ingredients').forEach(section => {
                    section.classList.add('hidden');
                });
                if (selectedProduct) {
                    document.getElementById(`${selectedProduct}-ingredients`).classList.remove('hidden');
                    addToCartBtn.classList.remove('hidden');
                } else {
                    addToCartBtn.classList.add('hidden');
                }
            });

            addToCartBtn.addEventListener('click', function() {
                const selectedProductType = mainProductSelect.value;
                let product = { id: Date.now(), type: selectedProductType, ingredients: {} };

                switch (selectedProductType) {
                    case 'fresas':
                        product.ingredients = {
                            subtype: document.getElementById('fresas-subtype').value,
                            complement: document.getElementById('fresas-complement').value,
                            topping: document.getElementById('fresas-topping').value,
                            whippedCream: document.getElementById('fresas-whipped-cream').checked
                        };
                        break;
                    case 'marranitas':
                        product.ingredients = {
                            cacahuate: document.getElementById('marranitas-cacahuate').checked,
                            pepino: document.getElementById('marranitas-pepino').checked,
                            tostaditas: document.getElementById('marranitas-tostaditas').checked,
                            cueritos: document.getElementById('marranitas-cueritos').checked,
                            clamato: document.getElementById('marranitas-clamato').checked,
                            tamarindo: document.getElementById('marranitas-tamarindo').checked,
                            chamoy: document.getElementById('marranitas-chamoy').checked,
                            valentina: document.getElementById('marranitas-valentina').checked,
                            soya: document.getElementById('marranitas-soya').checked,
                            limon: document.getElementById('marranitas-limon').checked
                        };
                        break;
                    case 'tostaditas':
                        product.ingredients = {
                            repollo: document.getElementById('tostaditas-repollo').checked,
                            cueritos: document.getElementById('tostaditas-cueritos').checked,
                            tomate: document.getElementById('tostaditas-tomate').checked,
                            queso: document.getElementById('tostaditas-queso').checked,
                            valentina: document.getElementById('tostaditas-valentina').checked,
                            crema: document.getElementById('tostaditas-crema').checked,
                            limon: document.getElementById('tostaditas-limon').checked
                        };
                        break;
                    case 'cheetos':
                        product.ingredients = {
                            subtype: document.getElementById('cheetos-type').value,
                            cueritos: document.getElementById('cheetos-cueritos').checked,
                            queso: document.getElementById('cheetos-queso').checked,
                            crema: document.getElementById('cheetos-crema').checked,
                            salsa: document.getElementById('cheetos-salsa').checked,
                            jalapeno: document.getElementById('cheetos-jalapeno').checked
                        };
                        break;
                }
                
                cart.push(product);
                updateCartDisplay();
                mainProductSelect.value = '';
                document.querySelectorAll('.product-ingredients').forEach(section => {
                    section.classList.add('hidden');
                });
                addToCartBtn.classList.add('hidden');
            });

            clearCartBtn.addEventListener('click', function() {
                if (confirm('¿Estás seguro de que quieres vaciar el carrito?')) {
                    cart = [];
                    updateCartDisplay();
                }
            });

            continueToConfirmBtn.addEventListener('click', function() {
                if (cart.length === 0) {
                    alert('El carrito está vacío. Agrega al menos un producto.');
                    return;
                }
                document.querySelector('[data-tab="confirm"]').click();
            });

            confirmOrderBtn.addEventListener('click', function() {
                if (cart.length === 0) {
                    alert('El carrito está vacío. Agrega al menos un producto.');
                    return;
                }
                const notes = document.getElementById('notes').value;
                let lastFolio = parseInt(localStorage.getItem('lastFolio') || 0);
                const newFolio = `LF${String(lastFolio + 1).padStart(4, '0')}`;
                localStorage.setItem('lastFolio', lastFolio + 1);
                const history = JSON.parse(localStorage.getItem('orderHistory')) || [];
                const now = new Date();
                const dateTime = now.toLocaleString('es-MX', { dateStyle: 'short', timeStyle: 'short' });
                
                cart.forEach(product => {
                    const historyItem = {
                        id: product.id,
                        folio: newFolio,
                        date: dateTime,
                        productType: product.type,
                        ingredients: product.ingredients
                    };
                    history.push(historyItem);
                });
                
                localStorage.setItem('orderHistory', JSON.stringify(history));
                confirmationMessage.style.display = 'block';
                confirmOrderBtn.style.display = 'none';
                cart = [];
                updateCartDisplay();
            });

            newOrderBtn.addEventListener('click', function() {
                cart = [];
                document.getElementById('notes').value = '';
                confirmationMessage.style.display = 'none';
                confirmOrderBtn.style.display = 'block';
                updateCartDisplay();
                updateOrderSummary();
                document.querySelector('[data-tab="order"]').click();
            });

            downloadCsvBtn.addEventListener('click', function() {
                const history = JSON.parse(localStorage.getItem('orderHistory')) || [];
                if (history.length === 0) {
                    alert('No hay historial de ventas para descargar.');
                    return;
                }
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Folio,Fecha-Hora,Producto,Subtipo,Ingredientes\n";
                history.forEach(item => {
                    let ingredientsString = '';
                    const mainType = getTypeName(item.productType);
                    let subtypeName = '';
                    let ingredientsList = [];
                    switch (item.productType) {
                        case 'fresas':
                            subtypeName = getFresasSubtypeNameForCSV(item.ingredients.subtype); // Usar nueva función para CSV
                            if (item.ingredients.complement && item.ingredients.complement !== 'nada') ingredientsList.push(getFresasComplementName(item.ingredients.complement));
                            if (item.ingredients.topping && item.ingredients.topping !== 'nada') ingredientsList.push(getFresasToppingName(item.ingredients.topping));
                            if (item.ingredients.whippedCream) ingredientsList.push('Crema Batida');
                            break;
                        case 'marranitas':
                            for (const key in item.ingredients) {
                                if (item.ingredients[key]) {
                                    ingredientsList.push(getMarranitasIngredientName(key));
                                }
                            }
                            break;
                        case 'tostaditas':
                            for (const key in item.ingredients) {
                                if (item.ingredients[key]) {
                                    ingredientsList.push(getTostaditasIngredientName(key));
                                }
                            }
                            break;
                        case 'cheetos':
                            subtypeName = getCheetosSubtypeName(item.ingredients.subtype);
                            for (const key in item.ingredients) {
                                if (key !== 'subtype' && item.ingredients[key]) {
                                    ingredientsList.push(getCheetosIngredientName(key));
                                }
                            }
                            break;
                    }
                    ingredientsString = ingredientsList.length > 0 ? ingredientsList.join(' + ') : 'Ninguno';
                    const row = [
                        `"${item.folio}"`,
                        `"${item.date}"`,
                        `"${mainType}"`,
                        `"${subtypeName}"`,
                        `"${ingredientsString}"`
                    ];
                    csvContent += row.join(",") + "\n";
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                const now = new Date();
                const dateString = now.toISOString().split('T')[0];
                link.setAttribute("download", `reporte_ventas_${dateString}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            function updateCartDisplay() {
                cartList.innerHTML = '';
                if (cart.length === 0) {
                    const emptyItem = document.createElement('li');
                    emptyItem.className = 'order-item empty-order';
                    emptyItem.textContent = 'No hay productos en el carrito. ¡Agrega tu primer pedido!';
                    cartList.appendChild(emptyItem);
                } else {
                    cart.forEach(product => {
                        const listItem = document.createElement('li');
                        listItem.className = 'order-item';
                        const productDisplayName = getProductDisplayName(product);
                        const ingredientsDisplay = getIngredientsDisplay(product);
                        listItem.innerHTML = `
                            <button class="delete-btn" data-id="${product.id}"><i class="fas fa-times"></i></button>
                            <div class="order-header">Producto: <strong>${productDisplayName}</strong></div>
                            <div class="order-details">Ingredientes: <strong>${ingredientsDisplay}</strong></div>
                        `;
                        const deleteBtn = listItem.querySelector('.delete-btn');
                        deleteBtn.addEventListener('click', function() {
                            const productId = parseInt(this.getAttribute('data-id'));
                            cart = cart.filter(item => item.id !== productId);
                            updateCartDisplay();
                        });
                        cartList.appendChild(listItem);
                    });
                }
                cartCount.textContent = cart.length;
                cartTotal.textContent = cart.length;
            }

            function updateOrderSummary() {
                orderSummary.innerHTML = '';
                if (cart.length === 0) {
                    const emptyItem = document.createElement('div');
                    emptyItem.className = 'empty-order';
                    emptyItem.textContent = 'No hay productos para confirmar';
                    orderSummary.appendChild(emptyItem);
                } else {
                    const summaryList = document.createElement('div');
                    cart.forEach((product, index) => {
                        const productDisplayName = getProductDisplayName(product);
                        const ingredientsDisplay = getIngredientsDisplayForSummary(product); // Nueva función para la confirmación
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'summary-item';
                        itemDiv.innerHTML = `
                            <div>${index + 1}. <strong>${productDisplayName}</strong></div>
                            <div>${ingredientsDisplay ? `Ingredientes: ${ingredientsDisplay}` : ''}</div>
                        `;
                        summaryList.appendChild(itemDiv);
                    });
                    const totalDiv = document.createElement('div');
                    totalDiv.className = 'summary-total';
                    totalDiv.innerHTML = `<div>Total de productos: ${cart.length}</div>`;
                    orderSummary.appendChild(summaryList);
                    orderSummary.appendChild(totalDiv);
                }
            }

            function loadHistory() {
                historyList.innerHTML = '';
                const history = JSON.parse(localStorage.getItem('orderHistory')) || [];
                if (history.length === 0) {
                    const emptyItem = document.createElement('div');
                    emptyItem.className = 'empty-order';
                    emptyItem.textContent = 'No hay pedidos registrados en el historial.';
                    historyList.appendChild(emptyItem);
                    downloadCsvBtn.style.display = 'none';
                } else {
                    const groupedHistory = history.reduce((acc, item) => {
                        const { folio } = item;
                        if (!acc[folio]) {
                            acc[folio] = { folio, date: item.date, items: [] };
                        }
                        acc[folio].items.push(item);
                        return acc;
                    }, {});
                    const sortedGroups = Object.values(groupedHistory).sort((a, b) => {
                        const folioA = parseInt(a.folio.replace('LF', ''));
                        const folioB = parseInt(b.folio.replace('LF', ''));
                        return folioB - folioA;
                    });
                    sortedGroups.forEach(group => {
                        const groupDiv = document.createElement('div');
                        groupDiv.className = 'history-group';
                        const headerDiv = document.createElement('div');
                        headerDiv.className = 'history-group-header';
                        headerDiv.innerHTML = `
                            <div>Folio: <strong>${group.folio}</strong> (${group.date})</div>
                        `;
                        groupDiv.appendChild(headerDiv);
                        group.items.forEach(item => {
                            const productDiv = document.createElement('div');
                            productDiv.className = 'history-product-item';
                            const productDisplayName = getProductDisplayName(item);
                            const ingredientsDisplay = getIngredientsDisplayForHistory(item); // Nueva función para el historial
                            productDiv.innerHTML = `
                                <button class="delete-btn" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                                <div>Producto: <strong>${productDisplayName}</strong><br>
                                ${ingredientsDisplay || 'Sin ingredientes'}</div>
                            `;
                            groupDiv.appendChild(productDiv);
                        });
                        historyList.appendChild(groupDiv);
                    });
                    downloadCsvBtn.style.display = 'block';
                }
            }

            historyList.addEventListener('click', function(e) {
                if (e.target.closest('.delete-btn')) {
                    const btn = e.target.closest('.delete-btn');
                    const itemId = parseInt(btn.getAttribute('data-id'));
                    const userPin = prompt('Por favor, ingresa el PIN para eliminar este pedido:');
                    if (userPin === HISTORY_PIN) {
                        let history = JSON.parse(localStorage.getItem('orderHistory')) || [];
                        history = history.filter(item => item.id !== itemId);
                        localStorage.setItem('orderHistory', JSON.stringify(history));
                        loadHistory();
                        alert('El pedido ha sido eliminado correctamente.');
                    } else {
                        alert('PIN incorrecto. No se puede eliminar el pedido.');
                    }
                }
            });

            function getProductDisplayName(product) {
                const productType = product.type || product.productType;
                switch (productType) {
                    case 'fresas': 
                        if (product.ingredients.subtype === 'mixtas') {
                            return 'Fresas Mixtas'; // Nuevo texto para Fresas Mixtas
                        }
                        return getFresasSubtypeName(product.ingredients.subtype);
                    case 'marranitas': return 'Marranitas';
                    case 'tostaditas': return 'Tostaditas';
                    case 'cheetos': return getCheetosSubtypeName(product.ingredients.subtype);
                    default: return '';
                }
            }

            // Función para el display de ingredientes en el Carrito
            function getIngredientsDisplay(product) {
                const productType = product.type || product.productType;
                let ingredientsParts = [];

                if (productType === 'fresas') {
                    const complementName = product.ingredients.complement !== 'nada' ? getFresasComplementName(product.ingredients.complement) : '';
                    const toppingName = product.ingredients.topping !== 'nada' ? getFresasToppingName(product.ingredients.topping) : '';

                    if (complementName) ingredientsParts.push(`Complemento: <strong>${complementName}</strong>`);
                    if (toppingName) ingredientsParts.push(`Topping: <strong>${toppingName}</strong>`); // Topping ya no está en negritas en la etiqueta, solo el valor
                    if (product.ingredients.whippedCream) ingredientsParts.push('Con Crema Batida');
                } else {
                    const selectedIngredients = Object.keys(product.ingredients).filter(key => product.ingredients[key]);
                    const ingredients = selectedIngredients.map(key => {
                        switch (productType) {
                            case 'marranitas': return getMarranitasIngredientName(key);
                            case 'tostaditas': return getTostaditasIngredientName(key);
                            case 'cheetos': 
                                if (key !== 'subtype') {
                                    return getCheetosIngredientName(key);
                                }
                                return null;
                        }
                    }).filter(Boolean);

                    if (ingredients.length > 0) {
                        ingredientsParts.push(`<strong>${ingredients.join(', ')}</strong>`);
                    }
                }
                
                return ingredientsParts.length > 0 ? ingredientsParts.join('<br>') : '<strong>Sin ingredientes</strong>';
            }

            // Nueva función para el display de ingredientes en la Confirmación
            function getIngredientsDisplayForSummary(product) {
                const productType = product.type || product.productType;
                let ingredientsParts = [];

                if (productType === 'fresas') {
                    const complementName = product.ingredients.complement !== 'nada' ? getFresasComplementName(product.ingredients.complement) : '';
                    const toppingName = product.ingredients.topping !== 'nada' ? getFresasToppingName(product.ingredients.topping) : '';

                    if (complementName) ingredientsParts.push(`Complemento: <strong>${complementName}</strong>`);
                    if (toppingName) ingredientsParts.push(`Topping: <strong>${toppingName}</strong>`); // Topping ya no está en negritas en la etiqueta, solo el valor
                    if (product.ingredients.whippedCream) ingredientsParts.push('Con Crema Batida');
                } else {
                    const selectedIngredients = Object.keys(product.ingredients).filter(key => product.ingredients[key]);
                    const ingredients = selectedIngredients.map(key => {
                        switch (productType) {
                            case 'marranitas': return getMarranitasIngredientName(key);
                            case 'tostaditas': return getTostaditasIngredientName(key);
                            case 'cheetos': 
                                if (key !== 'subtype') {
                                    return getCheetosIngredientName(key);
                                }
                                return null;
                        }
                    }).filter(Boolean);

                    if (ingredients.length > 0) {
                        ingredientsParts.push(`<strong>${ingredients.join(', ')}</strong>`);
                    }
                }
                
                return ingredientsParts.length > 0 ? ingredientsParts.join('<br>') : '<strong>Sin ingredientes</strong>';
            }

            // Nueva función para el display de ingredientes en el Historial
            function getIngredientsDisplayForHistory(product) {
                const productType = product.type || product.productType;
                let ingredientsParts = [];

                if (productType === 'fresas') {
                    const complementName = product.ingredients.complement !== 'nada' ? getFresasComplementName(product.ingredients.complement) : '';
                    const toppingName = product.ingredients.topping !== 'nada' ? getFresasToppingName(product.ingredients.topping) : '';

                    if (complementName) ingredientsParts.push(`Complemento: <strong>${complementName}</strong>`); // Complemento sin negritas en la etiqueta
                    if (toppingName) ingredientsParts.push(`Topping: <strong>${toppingName}</strong>`); // Topping sin negritas en la etiqueta
                    if (product.ingredients.whippedCream) ingredientsParts.push('Con Crema Batida');
                } else {
                    const selectedIngredients = Object.keys(product.ingredients).filter(key => product.ingredients[key]);
                    const ingredients = selectedIngredients.map(key => {
                        switch (productType) {
                            case 'marranitas': return getMarranitasIngredientName(key);
                            case 'tostaditas': return getTostaditasIngredientName(key);
                            case 'cheetos': 
                                if (key !== 'subtype') {
                                    return getCheetosIngredientName(key);
                                }
                                return null;
                        }
                    }).filter(Boolean);

                    if (ingredients.length > 0) {
                        ingredientsParts.push(`Ingredientes: <strong>${ingredients.join(', ')}</strong>`);
                    }
                }
                
                return ingredientsParts.length > 0 ? ingredientsParts.join('<br>') : 'Sin ingredientes';
            }

            function getTypeName(type) {
                switch(type) {
                    case 'fresas': return 'Fresas con Crema';
                    case 'marranitas': return 'Marranitas';
                    case 'tostaditas': return 'Tostaditas';
                    case 'cheetos': return 'Cheetos / Doritos';
                    default: return '';
                }
            }
            
            function getFresasSubtypeName(subtype) {
                switch(subtype) {
                    case 'congeladas': return 'Fresas con Crema Congeladas';
                    case 'naturales': return 'Fresas con Crema Naturales';
                    case 'mixtas': return 'Fresas Mixtas'; // Texto simplificado
                    default: return '';
                }
            }

            function getFresasSubtypeNameForCSV(subtype) {
                switch(subtype) {
                    case 'congeladas': return 'Fresas con Crema Congeladas';
                    case 'naturales': return 'Fresas con Crema Naturales';
                    case 'mixtas': return 'Fresas Mixtas (Congeladas + Naturales)'; // Mantener el detalle para CSV
                    default: return '';
                }
            }

            function getFresasComplementName(complement) {
                switch(complement) {
                    case 'oreo': return 'Oreo';
                    case 'chips-ahoy': return 'Chips Ahoy';
                    case 'canelitas': return 'Canelitas';
                    case 'gansito': return 'Gansito';
                    default: return '';
                }
            }
            
            function getFresasToppingName(topping) {
                switch(topping) {
                    case 'chocolate': return 'Chocolate líquido';
                    case 'cajeta': return 'Cajeta';
                    case 'nutella': return 'Nutella';
                    case 'caramelo': return 'Caramelo';
                    case 'nuez': return 'Nuez';
                    case 'almendra': return 'Almendra';
                    case 'jarabe-fresa': return 'Jarabe de fresa';
                    default: return '';
                }
            }

            function getMarranitasIngredientName(key) {
                const names = {
                    cacahuate: 'Cacahuate', pepino: 'Pepino', tostaditas: 'Tostaditas', cueritos: 'Cueritos',
                    clamato: 'Clamato', tamarindo: 'Tamarindo', chamoy: 'Chamoy', valentina: 'Salsa Valentina',
                    soya: 'Soya', limon: 'Limón'
                };
                return names[key] || '';
            }

            function getTostaditasIngredientName(key) {
                const names = {
                    repollo: 'Repollo', cueritos: 'Cueritos', tomate: 'Tomate', queso: 'Queso',
                    valentina: 'Salsa Valentina', crema: 'Crema', limon: 'Limón'
                };
                return names[key] || '';
            }

            function getCheetosSubtypeName(subtype) {
                const names = {
                    'cheetos-flamin': 'Cheetos Flamin',
                    'cheetos-flamin-limon': 'Cheetos Flamin Limón',
                    'cheetos-flamin-xxtra': 'Cheetos Flamin XXTRA',
                    'doritos': 'Doritos'
                };
                return names[subtype] || '';
            }

            function getCheetosIngredientName(key) {
                const names = {
                    cueritos: 'Cueritos', queso: 'Queso', crema: 'Crema', salsa: 'Salsa', jalapeno: 'Jalapeño'
                };
                return names[key] || '';
            }
        });
    </script>
</body>
</html>
